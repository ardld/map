<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Real Romania • Photo Map</title>
<style>
  :root { --left: 380px; --bg:#ffffff; --panel:#f6f7f9; --text:#111; --muted:#5a6b7b; --border:#e7eaef; --accent:#2f6fed; }
  * { box-sizing: border-box; }
  html, body { height: 100%; margin:0; background:var(--bg); color:var(--text); font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
  #wrap { display: grid; grid-template-columns: var(--left) 1fr; height: 100%; }
  #left { background: var(--panel); border-right: 1px solid var(--border); display:flex; flex-direction:column; min-width:0; }
  #brand { padding: 12px 14px; border-bottom:1px solid var(--border); font-weight:650; letter-spacing:.2px; }
  #toc { padding: 8px; overflow:auto; flex: 1 1 auto; }
  .toc-item { padding: 8px 10px; border-radius: 10px; cursor: pointer; display:flex; align-items:center; gap:10px; border:1px solid transparent; }
  .toc-item:hover { background:#eef3ff; border-color:#dde7ff; }
  .toc-item.active { background:#e9efff; border-color:#d6e3ff; }
  .dot { width:8px; height:8px; border-radius:50%; background:var(--accent); opacity:.85; }
  .toc-title { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; }
  .toc-count { margin-left:auto; color:var(--muted); font-size:12px; }
  #explain { padding: 14px; border-top:1px solid var(--border); }
  #explain h3 { margin: 6px 0 0 0; font-size: 16px; }
  #explain p { margin: 0 0 8px 0; color: var(--muted); }
  #explain .thumb { width: 100%; border-radius:12px; margin-top:10px; display:block; border:1px solid var(--border); }
  #map { width: 100%; height: 100%; }
  /* InfoWindow (on map) */
  .gm-popup { max-width: 360px; }
  .gm-popup .imgwrap img { width: 100%; height:auto; display:block; border-radius:10px; }
  .gm-pager { display:flex; align-items:center; justify-content:space-between; gap:8px; margin:6px 0; }
  .gm-btn { border: 1px solid #cdd5df; background: #fff; border-radius: 8px; padding: 4px 10px; cursor: pointer; }
  .gm-count { font-size: 12px; color:#5a6b7b; }
  .gm-title { font-weight:650; margin:6px 0 2px 0; }
  .gm-meta { color:#6b7a88; font-size:12px; }
  /* Lightbox */
  #lightbox { position: fixed; inset: 0; background: rgba(0,0,0,.92); display: none; align-items: center; justify-content: center; z-index: 9999; }
  #lightbox img { max-width: 92vw; max-height: 90vh; display: block; }
  #lightbox .close { position: absolute; top: 12px; right: 16px; font-size: 28px; color: #fff; cursor: pointer; }
  #lightbox .nav { position: absolute; top: 50%; transform: translateY(-50%); font-size: 28px; color: #fff; background: rgba(0,0,0,.4); border: 1px solid rgba(255,255,255,.3); border-radius: 8px; padding: 6px 12px; cursor: pointer; user-select: none; }
  #lightbox .prev { left: 16px; } .#lightbox .next { right: 16px; }
  #lightbox .counter { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); color: #fff; font-size: 13px; opacity: .8; }
</style>
</head>
<body>
<div id="wrap">
  <div id="left">
    <div id="brand">Real Romania • Cuprins</div>
    <div id="toc" role="navigation" aria-label="Places"></div>
    <div id="explain">
      <p>Selectează un loc din stânga sau un pin pe hartă.</p>
      <h3>&nbsp;</h3>
    </div>
  </div>
  <div id="map"></div>
</div>

<!-- Lightbox -->
<div id="lightbox" aria-modal="true" role="dialog">
  <span class="close" aria-label="Close">×</span>
  <button class="nav prev" aria-label="Previous">‹</button>
  <img alt="">
  <button class="nav next" aria-label="Next">›</button>
  <div class="counter"></div>
</div>

<script>
const DATA_URL = 'locations.json?ts=' + Date.now();
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsT9RvYBryqFnJJpjEuHbtu1WveVMSoaI&callback=initMap" defer async></script>
<script>
function groupByCoord(features) {
  const by = new Map();
  for (const f of features) {
    const c = f.geometry?.coordinates;
    const p = f.properties || {};
    if (!c || c.length < 2) continue;
    const lat = +c[1], lng = +c[0];
    const key = lat.toFixed(5) + "," + lng.toFixed(5);
    const item = {
      title: p.title || "",
      place_title: p.place_title || p.title || "",
      cuprins_title: p.cuprins_title || "",
      blurb: p.blurb || "",
      cuprins_desc: p.cuprins_desc || "",
      taken_at: p.taken_at || "",
      thumb: p.thumb || null,
      thumb_external: p.thumb_external || null,
      full_external: p.full_external || p.thumb_external || p.thumb || null,
      lat, lng
    };
    if (!by.has(key)) by.set(key, { lat, lng, items: [item] });
    else by.get(key).items.push(item);
  }
  // prefer cuprins_title for group title
  return Array.from(by.values()).map(g=>{
    const pick = (get) => {
      const freq = new Map();
      for (const it of g.items) {
        const t = get(it) || "";
        freq.set(t, (freq.get(t)||0)+1);
      }
      let best = ""; let bestCount = -1;
      for (const [t,c] of freq) if (t && c>bestCount) { best=t; bestCount=c; }
      return best;
    };
    g.title = pick(it=>it.cuprins_title) || pick(it=>it.place_title) || "Loc";
    return g;
  });
}
function toggleDropboxParam(u){
  try{
    const url = new URL(u);
    if (url.hostname.includes('dropbox')) {
      const hasRaw = url.searchParams.get('raw') === '1';
      const hasDl  = url.searchParams.get('dl') === '1';
      if (hasRaw) { url.searchParams.delete('raw'); url.searchParams.set('dl','1'); }
      else if (hasDl) { url.searchParams.delete('dl'); url.searchParams.set('raw','1'); }
      else { url.searchParams.set('raw','1'); }
      return url.toString();
    }
  }catch{}
  return u;
}

let map, info;
let groups = [];
let markers = [];
let currentGroup = null;
let currentIndex = 0;

const left = {
  toc: null,
  explain: null,
  lightbox: null,
  lbImg: null, lbClose: null, lbPrev: null, lbNext: null, lbCount: null,
};

function attachImgFallback(imgEl, it){
  imgEl.addEventListener('error', () => {
    const alt = toggleDropboxParam(imgEl.src);
    if (alt !== imgEl.src) { imgEl.src = alt; return; }
    if (it.full_external && imgEl.src !== it.full_external) { imgEl.src = it.full_external; return; }
    if (it.thumb_external && imgEl.src !== it.thumb_external) { imgEl.src = it.thumb_external; return; }
  });
}
function renderExplain(group, idx){
  currentGroup = group; currentIndex = ((idx % group.items.length)+group.items.length)%group.items.length;
  const it = group.items[currentIndex];
  const ex = left.explain;
  ex.innerHTML = "";

  // DESCRIPTION FIRST
  const p = document.createElement('p');  p.textContent = it.cuprins_desc || it.blurb || '';
  const h = document.createElement('h3'); h.textContent = it.cuprins_title || it.place_title || it.title || 'Foto';

  ex.appendChild(p);
  ex.appendChild(h);

  const imgSrc = it.thumb || it.thumb_external || it.full_external;
  if (imgSrc) {
    const a = document.createElement('a'); a.href="#";
    const img = document.createElement('img'); img.className="thumb"; img.alt=it.title||"";
    img.src = imgSrc; attachImgFallback(img, it);
    a.appendChild(img);
    a.onclick = (e)=>{ e.preventDefault(); openLightbox(group, currentIndex); };
    ex.appendChild(a);
  }
}
function openLightbox(group, index) {
  currentGroup = group; currentIndex = ((index % group.items.length)+group.items.length)%group.items.length;
  const n = group.items.length; const it = group.items[currentIndex];
  const src = it.full_external || it.thumb_external || it.thumb;
  left.lightbox.style.display='flex';
  left.lbImg.src = src || "";
  left.lbCount.textContent = (n>1) ? ( (currentIndex+1)+" / "+n ) : "";
  left.lbPrev.style.display = (n>1) ? "block" : "none";
  left.lbNext.style.display = (n>1) ? "block" : "none";
  left.lbImg.onerror = ()=> {
    const alt = toggleDropboxParam(left.lbImg.src);
    if (alt !== left.lbImg.src) { left.lbImg.src = alt; return; }
    if (it.thumb_external && left.lbImg.src !== it.thumb_external) { left.lbImg.src = it.thumb_external; return; }
  };
}
function closeLightbox(){ left.lightbox.style.display='none'; left.lbImg.src=""; }
function stepLightbox(delta){
  if (!currentGroup) return;
  const n = currentGroup.items.length;
  currentIndex = ((currentIndex + delta) % n + n) % n;
  openLightbox(currentGroup, currentIndex);
}

function renderPopup(marker, group, idx) {
  const n = group.items.length;
  const i = ((idx % n) + n) % n;
  const it = group.items[i];
  const imgSrc = it.thumb || it.thumb_external || null;
  const html =
    '<div class="gm-popup" data-idx="'+i+'">' +
      (n>1 ? (
        '<div class="gm-pager">' +
          '<button class="gm-btn gm-prev" aria-label="Previous">‹ Prev</button>' +
          '<span class="gm-count">'+(i+1)+' / '+n+'</span>' +
          '<button class="gm-btn gm-next" aria-label="Next">Next ›</button>' +
        '</div>'
      ) : '') +
      (imgSrc ? ('<div class="imgwrap">' +
                   '<a href="#" class="imglink" data-idx="'+i+'">' +
                     '<img loading="lazy" class="gm-img" src="'+imgSrc+'" alt="'+(it.title||'')+'">' +
                   '</a>' +
                 '</div>') : '') +
      '<div class="gm-title">'+(it.cuprins_title || it.place_title || it.title || '')+'</div>' +
      (it.taken_at ? '<div class="gm-meta">'+it.taken_at+'</div>' : '') +
    '</div>';

  info.setContent(html);
  info.open({ anchor: marker, map });

  google.maps.event.addListenerOnce(info, 'domready', () => {
    const prev = document.querySelector('.gm-prev');
    const next = document.querySelector('.gm-next');
    const link = document.querySelector('.imglink');
    const img  = document.querySelector('.gm-img');

    if (img) attachImgFallback(img, it);
    if (prev) prev.onclick = (e)=>{ e.preventDefault(); renderPopup(marker, group, i-1); renderExplain(group, i-1); };
    if (next) next.onclick = (e)=>{ e.preventDefault(); renderPopup(marker, group, i+1); renderExplain(group, i+1); };
    if (link) link.onclick = (e)=>{ e.preventDefault(); openLightbox(group, i); };
  });

  renderExplain(group, i);
}

function buildTOC(groups) {
  const toc = left.toc; toc.innerHTML = "";
  groups.forEach((g, idx)=>{
    const item = document.createElement('div');
    item.className = 'toc-item';
    const dot = document.createElement('div'); dot.className = 'dot';
    const title = document.createElement('div'); title.className = 'toc-title'; title.textContent = g.title || ('Loc ' + (idx+1));
    const count = document.createElement('div'); count.className = 'toc-count'; count.textContent = g.items.length + ' foto' + (g.items.length>1?'s':'');
    item.appendChild(dot); item.appendChild(title); item.appendChild(count);
    item.onclick = ()=>{
      document.querySelectorAll('.toc-item').forEach(el=>el.classList.remove('active'));
      item.classList.add('active');
      const m = markers[idx];
      map.panTo({ lat: g.lat, lng: g.lng });
      map.setZoom(Math.max(map.getZoom(), 10));
      google.maps.event.trigger(m, 'click');
    };
    toc.appendChild(item);
  });
}

async function initMap() {
  // sidebar refs
  left.toc = document.getElementById('toc');
  left.explain = document.getElementById('explain');
  left.lightbox = document.getElementById('lightbox');
  left.lbImg = left.lightbox.querySelector('img');
  left.lbClose = left.lightbox.querySelector('.close');
  left.lbPrev = left.lightbox.querySelector('.prev');
  left.lbNext = left.lightbox.querySelector('.next');
  left.lbCount = left.lightbox.querySelector('.counter');

  left.lbClose.onclick = closeLightbox;
  left.lightbox.addEventListener('click', (e)=>{ if(e.target===left.lightbox) closeLightbox(); });
  left.lbPrev.onclick = (e)=>{ e.preventDefault(); stepLightbox(-1); };
  left.lbNext.onclick = (e)=>{ e.preventDefault(); stepLightbox(1); };
  document.addEventListener('keydown', (e)=>{
    if (left.lightbox.style.display === 'flex') {
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft')  { e.preventDefault(); stepLightbox(-1); }
      if (e.key === 'ArrowRight') { e.preventDefault(); stepLightbox(1); }
    }
  });

  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 45.94, lng: 25.0 },
    zoom: 6,
    mapTypeControl: false,
    streetViewControl: false,
    fullscreenControl: false
  });
  info = new google.maps.InfoWindow();

  try {
    const res = await fetch(DATA_URL);
    const geo = await res.json();
    groups = groupByCoord(geo.features || []);
    markers = [];

    // markers (NO clusters)
    for (const g of groups) {
      const m = new google.maps.Marker({ position: { lat: g.lat, lng: g.lng } });
      m.addListener('click', () => renderPopup(m, g, 0));
      markers.push(m);
    }
    markers.forEach(m=>m.setMap(map));

    // Initial fit to all markers
    if (markers.length) {
      const b = new google.maps.LatLngBounds();
      markers.forEach(m => b.extend(m.getPosition()));
      map.fitBounds(b);
      google.maps.event.addListenerOnce(map, 'idle', () => {
        if (map.getZoom() > 8) map.setZoom(8);
      });
    }

    buildTOC(groups);
  } catch (e) {
    console.error('Failed to load data', e);
  }
}
</script>
</body>
</html>