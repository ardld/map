<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Photo Map â€¢ Google Maps</title>
<style>
  html, body, #map { height: 100%; margin: 0; }
  .gm-popup { max-width: 320px; font: 13px/1.35 system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; }
  .gm-popup img { width: 100%; height: auto; display: block; border-radius: 8px; margin-bottom: 6px; }
  .gm-title { font-weight: 600; margin-bottom: 2px; }
  .gm-meta { opacity: .7; font-size: 12px; }
</style>
</head>
<body>
<div id="map"></div>

<script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
<script>
async function initMap() {
  const map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: 45.94, lng: 25.0 }, zoom: 6, mapTypeControl: false
  });

  try {
    const res = await fetch('locations.json?ts=' + Date.now());
    const geo = await res.json();
    const markers = [];

    for (const f of geo.features || []) {
      const c = f.geometry?.coordinates;
      if (!c || c.length < 2) continue;
      const lat = c[1], lng = c[0];

      const p = f.properties || {};
      const title = p.title || '';
      const imgSrc = p.thumb || null;
      const linkTo = p.original_page || null;

      const html =
        '<div class="gm-popup">' +
          (imgSrc ? ('<a ' + (linkTo ? 'href="'+linkTo+'" target="_blank" rel="noopener"' : '') + '>' +
                     '<img loading="lazy" src="'+imgSrc+'" alt="'+title+'"></a>') : '') +
          '<div class="gm-title">' + title + '</div>' +
          (p.taken_at ? '<div class="gm-meta">' + p.taken_at + '</div>' : '') +
        '</div>';

      const info = new google.maps.InfoWindow({ content: html });
      const m = new google.maps.Marker({ position: { lat, lng }, title });
      m.addListener('click', () => info.open({ anchor: m, map }));
      markers.push(m);
    }

    if (markers.length) {
      new markerClusterer.MarkerClusterer({ map, markers });
      const b = new google.maps.LatLngBounds();
      markers.forEach(m => b.extend(m.getPosition()));
      map.fitBounds(b);
    }
  } catch (e) {
    console.error('Failed to load data', e);
  }
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAsT9RvYBryqFnJJpjEuHbtu1WveVMSoaI&callback=initMap" defer async></script>
</body>
</html>